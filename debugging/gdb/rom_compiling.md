# Compiling the ROM for usage with gdb

gdb is a lot more powerful when it has access to the debugging information generated by the compiler during compilation.

This debugging information varies with the compiler used, and the compiler flags provided. It is stored in the .elf file produced by the linker, ld. None of it is found in the .z64 rom file.

gdb can also be used without any kind of debug information, but it's a poor experience since it means you don't even have function names.

# With IDO

IDO, the original compiler used to build a matching rom, generates debug information that can in theory be understood by GDB (in a special section of the elf known as `.mdebug`)

Unfortunately it seems that the linker ld messes up this debugging information when linking the .o object files into the elf file. This results in gdb crashing when reading debug information for an IDO-built elf.

A workaround is to strip the `.mdebug` section from the elf and load the resulting elf into gdb. The debug information will be limited, but at least there will be function names:

```sh
# Remove .mdebug section from zelda_ocarina_mq_dbg.elf and write resulting elf to zelda_ocarina_mq_dbg_NOMDEBUG.elf
mips-linux-gnu-objcopy --remove-section=.mdebug zelda_ocarina_mq_dbg.elf zelda_ocarina_mq_dbg_NOMDEBUG.elf

# This may print scary warnings like
# "mips-linux-gnu-objcopy: zelda_ocarina_mq_dbg_NOMDEBUG.elf: section `..Audiobank' can't be allocated in segment 2",
# afaict it seems fine to ignore them
```

# With GCC

The OoT decomp supports compiling the rom using gcc, by setting the `COMPILER` Makefile variable to `gcc`.

When compiling with gcc, if you want a good gdb experience you want to add `-ggdb` to the `OPTFLAGS` Makefile variable:

https://github.com/zeldaret/oot/blob/1f9c28f370d73268981fd8a42f9c6ac15b560a1a/Makefile#L114

For example:

```Makefile
  OPTFLAGS := -Os -ggdb -ffast-math -fno-unsafe-math-optimizations
```

You may also change the optimization flag `-Os` to the `-Og` "optimize for debugging" flag, but that may significantly slow down execution as well as unreasonably increasing rom size. The memory may also run out quicker from the code taking more space due to lack of optimization, leading to crashes.
